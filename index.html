<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>–ê–ª—Ñ–∞–≤–∏—Ç–Ω–∞—è –ò–≥—Ä–∞</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    body {
      font-family: 'Arial', sans-serif;
      margin: 0;
      padding: 0;
      text-align: center;
      background: linear-gradient(135deg, #1d1d1d, #3a3a3a);
      color: #fff;
      display: flex;
      flex-direction: column;
      min-height: 100vh;
      justify-content: center;
      align-items: center;
    }
    h1 {
      font-size: 1.5rem;
      margin-bottom: 20px;
      text-shadow: 2px 2px 5px rgba(0,0,0,0.5);
    }
    .letter {
      font-size: 120px;
      margin: 20px;
      padding: 15px 30px;
      border-radius: 12px;
      background-color: rgba(255, 255, 255, 0.1);
      box-shadow: 0 4px 6px rgba(0,0,0,0.3);
    }
    .score {
      font-size: 1.5rem;
      margin-bottom: 30px;
    }
    .mode-container {
      margin-bottom: 20px;
      font-size: 1.2rem;
    }
    .switch {
      position: relative;
      display: inline-block;
      width: 40px;
      height: 20px;
      vertical-align: middle;
      margin-right: 10px;
    }
    .switch input {
      opacity: 0;
      width: 0;
      height: 0;
    }
    .slider {
      position: absolute;
      cursor: pointer;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: #ccc;
      transition: 0.4s;
      border-radius: 20px;
    }
    .slider:before {
      position: absolute;
      content: "";
      height: 16px;
      width: 16px;
      left: 2px;
      bottom: 2px;
      background-color: white;
      transition: 0.4s;
      border-radius: 50%;
    }
    input:checked + .slider {
      background-color: #2196F3;
    }
    input:checked + .slider:before {
      transform: translateX(20px);
    }
    .buttons {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 15px;
    }
    button {
      font-size: 1rem;
      padding: 12px 25px;
      cursor: pointer;
      border: none;
      border-radius: 8px;
      transition: background-color 0.3s, transform 0.2s;
    }
    button:hover {
      transform: scale(1.05);
    }
    .correct {
      background-color: #28a745;
      color: white;
    }
    .wrong {
      background-color: #dc3545;
      color: white;
    }
    .speak {
      background-color: #6c757d;
      color: white;
    }
    .restart {
      background-color: #007bff;
      color: white;
    }
    .hidden {
      display: none;
    }
    .result {
      font-size: 1.5rem;
      margin: 20px;
      padding: 15px 30px;
      border-radius: 12px;
      background-color: rgba(255, 255, 255, 0.1);
      box-shadow: 0 4px 6px rgba(0,0,0,0.3);
    }
  </style>
</head>
<body>
  <h1>–ê–ª—Ñ–∞–≤–∏—Ç–Ω–∞—è –ò–≥—Ä–∞</h1>
  <div class="letter" id="letter">?</div>
  <div class="score" id="score">‚úÖ 0 | ‚ùå 0</div>
  <!-- –ü–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—å –¥–ª—è –≤—ã–±–æ—Ä–∞ –º–µ—Ç–æ–¥–∞ –≤–≤–æ–¥–∞ -->
  <div class="mode-container">
    <label class="switch">
      <input type="checkbox" id="modeToggle">
      <span class="slider"></span>
    </label>
    <span id="modeLabel">–ö–Ω–æ–ø–∫–∏</span>
  </div>
  <!-- –ö–Ω–æ–ø–∫–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è -->
  <div class="buttons">
    <button class="correct" id="correctBtn" onclick="handleAnswer(true)">‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω–æ</button>
    <button class="wrong" id="wrongBtn" onclick="handleAnswer(false)">‚ùå –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ</button>
    <button class="speak hidden" id="speakBtn" onclick="startRecognition()">üé§ –ü—Ä–æ–∏–∑–Ω–µ—Å—Ç–∏</button>
    <button class="restart hidden" id="restartBtn" onclick="restartWithWrongLetters()">üîÑ –ü–æ–≤—Ç–æ—Ä–∏—Ç—å –æ—à–∏–±–∫–∏</button>
    <button class="restart hidden" id="newGameBtn" onclick="startNewGame()">üîÑ –ù–∞—á–∞—Ç—å –∑–∞–Ω–æ–≤–æ</button>
  </div>
  <script>
    // –ò—Å—Ö–æ–¥–Ω—ã–π –º–∞—Å—Å–∏–≤ –±—É–∫–≤
    const originalLetters = "–ê–ë–í–ì–î–ï–Å–ñ–ó–ò–ô–ö–õ–ú–ù–û–ü–†–°–¢–£–§–•–¶–ß–®–©–™–´–¨–≠–Æ–Ø".split("");
    const vowels = ["–ê", "–ï", "–Å", "–ò", "–û", "–£", "–´", "–≠", "–Æ", "–Ø"];

    let gameLetters = [];
    let index = 0;
    let correctCount = 0;
    let wrongCount = 0;
    let wrongLetters = [];
    let isRestarting = false;
    let currentLetter = ""; // –ì–ª–æ–±–∞–ª—å–Ω–∞—è –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è –¥–ª—è —Ç–µ–∫—É—â–µ–π –±—É–∫–≤—ã

    const letterDiv = document.getElementById("letter");
    const scoreDiv = document.getElementById("score");
    const correctBtn = document.getElementById("correctBtn");
    const wrongBtn = document.getElementById("wrongBtn");
    const speakBtn = document.getElementById("speakBtn");
    const restartBtn = document.getElementById("restartBtn");
    const newGameBtn = document.getElementById("newGameBtn");
    const modeLabel = document.getElementById("modeLabel");
    const modeToggle = document.getElementById("modeToggle");

    // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ä–µ–∂–∏–º–∞ –≤–≤–æ–¥–∞
    modeToggle.addEventListener("change", updateInputMode);

    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è —Ä–µ–∂–∏–º–∞ –≤–≤–æ–¥–∞
    function updateInputMode() {
      if (modeToggle.checked) {
        modeLabel.textContent = "–ì–æ–ª–æ—Å";
        correctBtn.classList.add("hidden");
        wrongBtn.classList.add("hidden");
        speakBtn.classList.remove("hidden");
      } else {
        modeLabel.textContent = "–ö–Ω–æ–ø–∫–∏";
        correctBtn.classList.remove("hidden");
        wrongBtn.classList.remove("hidden");
        speakBtn.classList.add("hidden");
      }
    }
    
    // –§—É–Ω–∫—Ü–∏—è –ø–µ—Ä–µ–º–µ—à–∏–≤–∞–Ω–∏—è –º–∞—Å—Å–∏–≤–∞
    function shuffleArray(array) {
      return array.slice().sort(() => Math.random() - 0.5);
    }
    
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –Ω–æ–≤–æ–π –∏–≥—Ä—ã —Å–æ —Å–ª—É—á–∞–π–Ω—ã–º –ø–æ—Ä—è–¥–∫–æ–º –±—É–∫–≤
    function initNewGame() {
      gameLetters = shuffleArray(originalLetters);
      console.log("gameLetters (–ø–æ—Å–ª–µ –ø–µ—Ä–µ–º–µ—à–∏–≤–∞–Ω–∏—è):", gameLetters);
      index = 0;
    }
    
    function nextLetter() {
      if (isRestarting) {
        if (index < wrongLetters.length) {
          currentLetter = wrongLetters[index];
        } else {
          endGame();
          return;
        }
      } else {
        if (index < gameLetters.length) {
          currentLetter = gameLetters[index];
        } else {
          endGame();
          return;
        }
      }
      console.log("–û—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è –±—É–∫–≤–∞:", currentLetter, "–ø—Ä–∏ –∏–Ω–¥–µ–∫—Å–µ:", index);
      // –ì–ª–∞—Å–Ω—ã–µ ‚Äì –∫—Ä–∞—Å–Ω—ã–µ, —Å–æ–≥–ª–∞—Å–Ω—ã–µ ‚Äì —Å–∏–Ω–∏–µ
      let color = vowels.includes(currentLetter) ? "red" : "blue";
      letterDiv.innerHTML = `<span style="color: ${color};">${currentLetter}</span>`;
    }
    
    function handleAnswer(isCorrect) {
      if (isRestarting) {
        if (isCorrect) {
          correctCount++;
        } else {
          wrongCount++;
        }
      } else {
        if (isCorrect) {
          correctCount++;
        } else {
          wrongCount++;
          wrongLetters.push(gameLetters[index]);
        }
      }
      index++;
      updateScore();
      nextLetter();
    }
    
    function updateScore() {
      scoreDiv.textContent = `‚úÖ ${correctCount} | ‚ùå ${wrongCount}`;
    }
    
    function endGame() {
      scoreDiv.classList.add("hidden");
      letterDiv.classList.replace("letter", "result");
      let wrongDisplay = "";
      if (!isRestarting && wrongLetters.length > 0) {
        wrongDisplay = `<br> –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ –±—É–∫–≤—ã: ${wrongLetters.join(", ")}`;
      }
      letterDiv.innerHTML = `üéâ –ò–≥—Ä–∞ –æ–∫–æ–Ω—á–µ–Ω–∞! <br> ‚úÖ ${correctCount} | ‚ùå ${wrongCount} ${wrongDisplay}`;
      correctBtn.classList.add("hidden");
      wrongBtn.classList.add("hidden");
      if (wrongLetters.length === 0) {
        restartBtn.classList.add("hidden");
      } else {
        restartBtn.classList.remove("hidden");
      }
      newGameBtn.classList.remove("hidden");
      Telegram.WebApp.sendData(JSON.stringify({ correct: correctCount, wrong: wrongCount }));
      Telegram.WebApp.close();
    }
    
    function restartWithWrongLetters() {
      if (wrongLetters.length > 0) {
        wrongLetters = shuffleArray(wrongLetters);
        index = 0;
        correctCount = 0;
        wrongCount = 0;
        isRestarting = true;
        letterDiv.classList.replace("result", "letter");
        scoreDiv.classList.remove("hidden");
        correctBtn.classList.remove("hidden");
        wrongBtn.classList.remove("hidden");
        restartBtn.classList.add("hidden");
        newGameBtn.classList.add("hidden");
        updateScore();
        nextLetter();
      } else {
        alert("–ù–µ—Ç –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã—Ö –±—É–∫–≤ –¥–ª—è –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏—è!");
      }
    }
    
    function startNewGame() {
      index = 0;
      correctCount = 0;
      wrongCount = 0;
      wrongLetters = [];
      isRestarting = false;
      initNewGame();
      letterDiv.classList.replace("result", "letter");
      scoreDiv.classList.remove("hidden");
      correctBtn.classList.remove("hidden");
      wrongBtn.classList.remove("hidden");
      restartBtn.classList.add("hidden");
      newGameBtn.classList.add("hidden");
      updateScore();
      nextLetter();
    }
    
    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∑–∞–ø—É—Å–∫–∞ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è —Ä–µ—á–∏
    function startRecognition() {
      const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
      if (!SpeechRecognition) {
        alert("–í–∞—à –±—Ä–∞—É–∑–µ—Ä –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ —Ä–µ—á–∏.");
        return;
      }
      
      const recognition = new SpeechRecognition();
      recognition.lang = 'ru-RU';
      recognition.interimResults = false;
      recognition.maxAlternatives = 1;
      
      recognition.addEventListener("result", (event) => {
        const transcript = event.results[0][0].transcript.trim().toUpperCase();
        console.log("–†–∞—Å–ø–æ–∑–Ω–∞–Ω–Ω–æ–µ —Å–ª–æ–≤–æ:", transcript);
        console.log("–û–∂–∏–¥–∞–ª–∞—Å—å –±—É–∫–≤–∞:", currentLetter);
        if (transcript === currentLetter) {
          alert("–ü—Ä–∞–≤–∏–ª—å–Ω–æ!");
          handleAnswer(true);
        } else {
          alert("–ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ! –í—ã —Å–∫–∞–∑–∞–ª–∏: " + transcript);
          handleAnswer(false);
        }
      });
      
      recognition.addEventListener("error", (event) => {
        alert("–û—à–∏–±–∫–∞ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è: " + event.error);
      });
      
      recognition.addEventListener("end", () => {
        // –ó–¥–µ—Å—å –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –¥–µ–π—Å—Ç–≤–∏—è –ø–æ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–∏ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è, –µ—Å–ª–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ.
      });
      
      // –ó–∞–ø—É—Å–∫–∞–µ–º —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ –ø–æ—Å–ª–µ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤
      recognition.start();
    }
    
    // –ó–∞–ø—É—Å–∫ –∏–≥—Ä—ã
    initNewGame();
    nextLetter();
  </script>
</body>
</html>